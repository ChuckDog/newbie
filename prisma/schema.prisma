// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"

  // Enable Full-Text Search which is only available for PostgreSQL.
  previewFeatures = ["fullTextSearch"]

  // For production deployment.
  // binaryTargets   = ["native", "rhel-openssl-1.0.x"]
  // binaryTargets   = ["native", "linux-arm64-openssl-1.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//       ! Enum Product          //
// ⌄  ⌄  ⌄  ⌄  ⌄  ⌄  ⌄  ⌄  ⌄  ⌄  //
// * DEFAULT                     //
// * DATATRANS_BATCH_PROCESSING   //
// * DATATRANS_STREAM_PROCESSING  //
// ⌄  ⌄  ⌄  ⌄  ⌄  ⌄  ⌄  ⌄  ⌄  ⌄  //

enum Product {
  DEFAULT
  DATATRANS_BATCH_PROCESSING
  DATATRANS_STREAM_PROCESSING
}

//       ! Notification         //
// ⌄  ⌄  ⌄  ⌄  ⌄  ⌄  ⌄  ⌄  ⌄  ⌄ //
// * EmailNotification          //
// * SmsNotification            //
// * NotificationConfiguration  //
// ⌄  ⌄  ⌄  ⌄  ⌄  ⌄  ⌄  ⌄  ⌄  ⌄ //

model EmailNotification {
  id                Int                       @id @default(autoincrement())
  payload           Json //  The notification content for one phone.
  pinpointRequestId String? // RequestId is the Pinpoint request id. One request can contain many text messages.
  pinpointMessageId String? // MessageId is the text message id.
  pinpointResponse  Json?
  createdAt         DateTime                  @default(now())
  updatedAt         DateTime                  @updatedAt
  configuration     NotificationConfiguration @relation(fields: [configurationId], references: [id])
  configurationId   String                    @db.Uuid
}

model SmsNotification {
  id                Int                       @id @default(autoincrement())
  payload           Json //  The notification content for one phone.
  pinpointRequestId String? // RequestId is the Pinpoint request id. One request can contain many text messages.
  pinpointMessageId String? // MessageId is the text message id.
  pinpointResponse  Json?
  createdAt         DateTime                  @default(now())
  updatedAt         DateTime                  @updatedAt
  configuration     NotificationConfiguration @relation(fields: [configurationId], references: [id])
  configurationId   String                    @db.Uuid
}

model NotificationConfiguration {
  id                    String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  product               Product             @unique // The product that uses the notification.
  pinpointApplicationId String
  pinpointFromAddress   String? // For email message
  pinpointSenderId      String? // For text message
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  emailNotifications    EmailNotification[]
  smsNotifications      SmsNotification[]
}

//      ! Task       //
// ⌄  ⌄  ⌄  ⌄  ⌄  ⌄  //
// * Task            //
// ⌄  ⌄  ⌄  ⌄  ⌄  ⌄  //

model Task {
  id              Int               @id @default(autoincrement())
  payload         Json // The task content.
  state           TaskState         @default(PENDING)
  sqsMessageId    String?
  sqsResponse     Json?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  configuration   TaskConfiguration @relation(fields: [configurationId], references: [id])
  configurationId String            @db.Uuid
}

enum TaskState {
  PENDING
  SUCCEEDED
  FAILED
  CANCELED
}

model TaskConfiguration {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  product     Product  @unique // The product that uses the notification.
  sqsQueueUrl String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tasks       Task[]
}

//     ! Account       //
// ⌄  ⌄  ⌄  ⌄  ⌄  ⌄  ⌄ //
// * Jwt               //
// * VerificationCode  //
// * User              //
// * Profile           //
// * Role              //
// * Permission        //
// * Organization      //
// ⌄  ⌄  ⌄  ⌄  ⌄  ⌄  ⌄ //

model Jwt {
  id        Int       @id @default(autoincrement())
  userId    String
  token     String
  status    JwtStatus
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

enum JwtStatus {
  ACTIVE
  INACTIVE
}

model VerificationCode {
  id        Int                    @id @default(autoincrement())
  userId    String?
  email     String?
  phone     String?
  code      String
  use       VerificationCodeUse
  status    VerificationCodeStatus
  expiredAt DateTime
  createdAt DateTime               @default(now())
  updatedAt DateTime               @updatedAt
}

enum VerificationCodeUse {
  UNKNOWN
  // For generating JWT.
  LOGIN_BY_EMAIL
  LOGIN_BY_PHONE
  // For closing and recovering account.
  CLOSE_ACCOUNT_BY_EMAIL
  CLOSE_ACCOUNT_BY_PHONE
  RECOVER_ACCOUNT_BY_EMAIL
  RECOVER_ACCOUNT_BY_PHONE
  // For other operations
  BIND_EMAIL
  BIND_PHONE
  CHANGE_PASSWORD
  RESET_PASSWORD
}

enum VerificationCodeStatus {
  ACTIVE
  INACTIVE
}

model User {
  // [1] The 'User' and 'VerificationCode' models are both used for logging in.
  // [2] The 'User' is designed for long-term use and the 'VerificationCode' is designed for short-term use.
  // [3] Actually, the 'User' model should be named 'UserPassword' and the 'VerificationCode' should be named 'UserVerificationCode'.

  id           String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email        String?    @unique
  phone        String?    @unique
  username     String?    @unique
  passwordHash String?
  status       UserStatus
  lastLoginAt  DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  profiles     Profile[]
}

enum UserStatus {
  ACTIVE
  INACTIVE
}

model Profile {
  id             String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  givenName      String?
  middleName     String?
  familyName     String?
  suffix         String?
  birthday       DateTime?
  gender         String?
  race           ProfileRaceType?
  ethnicity      ProfileEthnicityType?
  hasPCP         Boolean? // Primary Care Physician  
  address        String?
  zipcode        String?
  geoJSON        Json? // https://datatracker.ietf.org/doc/html/rfc7946
  websites       Json? // {'facebook': 'https://www.facebook.com/grace', 'twitter': 'https://twitter.com/elonmusk'}
  picture        String?
  organizationId String?               @db.Uuid
  createdAt      DateTime              @default(now())
  updatedAt      DateTime              @updatedAt
  user           User                  @relation(fields: [userId], references: [id])
  userId         String                @db.Uuid
}

enum ProfileRaceType {
  AA
  WHITE
  ASIAN
  MULTI
  OTHER
}

enum ProfileEthnicityType {
  HISPANIC
  NOT_HISPANIC
}

model Role {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Permission {
  id            String                  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  resource      String
  allowedAction PermissionAllowedAction
  attributes    String
  createdAt     DateTime                @default(now())
  updatedAt     DateTime                @updatedAt
}

enum PermissionAllowedAction {
  CREATE
  UPDATE
  RETRIEVE
  DELETE
}

model User_Role {
  userId String @db.Uuid
  roleId String @db.Uuid

  @@id([userId, roleId])
}

model User_Permission {
  userId       String @db.Uuid
  permissionId String @db.Uuid

  @@id([userId, permissionId])
}

model Role_Permission {
  roleId       String @db.Uuid
  permissionId String @db.Uuid

  @@id([roleId, permissionId])
}

model Organization {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//  ! Project Management  //
// ⌄  ⌄  ⌄  ⌄  ⌄  ⌄  ⌄  ⌄ //
// * Project              //
// * ProjectCheckpoint    //
// * ProjectEnvironment   //
// * InfrastructureStack  //
// ⌄  ⌄  ⌄  ⌄  ⌄  ⌄  ⌄  ⌄ //

model Project {
  id                   String                @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                 String                @unique
  state                ProjectState
  clientName           String?
  clientEmail          String?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  checkpoints          ProjectCheckpoint[]
  environments         ProjectEnvironment[]
  infrastructureStacks InfrastructureStack[]
}

enum ProjectState {
  DESIGNING
  DEVELOPING
  DONE
}

model ProjectCheckpoint {
  type      ProjectCheckpointType
  content   String?
  createdAt DateTime              @default(now())
  updatedAt DateTime              @updatedAt
  Project   Project               @relation(fields: [projectId], references: [id])
  projectId String                @db.Uuid

  @@id([type, projectId])
}

enum ProjectCheckpointType {
  MGMT_JIRA
  DESIGN_FIGMA
  ACCOUNT_APPLE
  ACCOUNT_GOOGLE
  CODE_FE_REPO
  CODE_FE_FRAMEWORK
  CODE_BE_REPO
  CODE_BE_FRAMEWORK
  CODE_BE_DATABASE
  CODE_BE_API
  INFRASTRUCTURE
}

model ProjectEnvironment {
  type               ProjectEnvironmentType
  awsAccountId       String?
  awsProfile         String?
  awsAccessKeyId     String?
  awsSecretAccessKey String? // hash
  awsRegion          String?
  cfTemplateS3       String?
  createdAt          DateTime               @default(now())
  updatedAt          DateTime               @updatedAt
  project            Project                @relation(fields: [projectId], references: [id])
  projectId          String                 @db.Uuid

  @@id([type, projectId])
}

enum ProjectEnvironmentType {
  DEVELOPMENT
  STAGING
  PRODUCTION
}

model InfrastructureStack {
  id                String                     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name              String                     @unique
  params            Json?
  environment       ProjectEnvironmentType
  type              InfrastructureStackType
  state             InfrastructureStackState
  manager           InfrastructureStackManager
  // We use 'pulumiProjectName' & 'name' to identify infrastructure stack(cloud resource stack).
  // The pulumiProjectName Name is a concept of Pulumi. We set it with Project->name.
  pulumiProjectName String?
  buildResult       Json?
  destroyResult     Json?
  createdAt         DateTime                   @default(now())
  updatedAt         DateTime                   @updatedAt
  project           Project                    @relation(fields: [projectId], references: [id])
  projectId         String                     @db.Uuid
}

enum InfrastructureStackManager {
  PULUMI
  CLOUDFORMATION
}

enum InfrastructureStackType {
  // CloudFormation stack types
  C_CICD_BUILD
  C_CICD_PIPELINE
  C_CICD_REPOSITORY
  C_COMPUTING_FARGATE
  C_NETWORK_HIPAA
  C_PRODUCT_IDE
  C_PRODUCT_MESSAGE_TRACKER
  // Pulumi stack types
  P_AWS_CLOUDFRONT
  P_AWS_CODE_COMMIT
  P_AWS_ECR
  P_AWS_ECS
  P_AWS_EKS
  P_AWS_IAM_USER
  P_AWS_RDS
  P_AWS_S3
  P_AWS_SQS
  P_AWS_VPC
  P_AWS_WAF
  P_COMPUTING_FARGATE
  P_NETWORK_HIPAA
}

enum InfrastructureStackState {
  PREPARING
  BUILDING
  BUILD_SUCCEEDED
  BUILD_FAILED
  DESTROYING
  DESTROY_SUCCEEDED
  DESTROY_FAILED
  DELETED
}

//            ! Engine D               //
// ⌄  ⌄  ⌄  ⌄  ⌄  ⌄  ⌄  ⌄  ⌄  ⌄  ⌄  ⌄  //
// * PostgresqlDatasource              //
// * PostgresqlDatasourceConstraint    //
// * PostgresqlDatasourceTable         //
// * PostgresqlDatasourceTableColumn   //
// ----------------------------------- //
// * ElasticsearchDatasource           //
// * ElasticsearchDatasourceIndex      //
// * ElasticsearchDatasourceIndexField //
// ----------------------------------- //
// * DatatransPipeline                 //
// ----------------------------------- //
// * ElasticsearchDataboard            //
// ⌄  ⌄  ⌄  ⌄  ⌄  ⌄  ⌄  ⌄  ⌄  ⌄  ⌄  ⌄  //

model PostgresqlDatasource {
  id          String                           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  host        String
  port        Int
  database    String
  schema      String
  createdAt   DateTime                         @default(now())
  updatedAt   DateTime                         @updatedAt
  tables      PostgresqlDatasourceTable[]
  constraints PostgresqlDatasourceConstraint[]
}

model PostgresqlDatasourceConstraint {
  id           Int                                   @id @default(autoincrement())
  schema       String // The schema name.
  table        String // The table name.
  keyColumn    String // The table's primary key column or foreign key column.
  keyType      PostgresqlDatasourceConstraintKeyType
  foreignTable String? // Has value when the type is FOREIGN_KEY. 
  createdAt    DateTime                              @default(now())
  updatedAt    DateTime                              @updatedAt
  datasource   PostgresqlDatasource                  @relation(fields: [datasourceId], references: [id])
  datasourceId String                                @db.Uuid
}

enum PostgresqlDatasourceConstraintKeyType {
  PRIMARY_KEY
  FOREIGN_KEY
}

model PostgresqlDatasourceTable {
  id                 Int                               @id @default(autoincrement())
  name               String
  createdAt          DateTime                          @default(now())
  updatedAt          DateTime                          @updatedAt
  datasource         PostgresqlDatasource              @relation(fields: [datasourceId], references: [id])
  datasourceId       String                            @db.Uuid
  columns            PostgresqlDatasourceTableColumn[]
  datatransPipelines DatatransPipeline[]
}

model PostgresqlDatasourceTableColumn {
  id              Int                       @id @default(autoincrement())
  column          String // The column name.
  columnType      String
  ordinalPosition Int // The sort number of the column in the table.
  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt
  table           PostgresqlDatasourceTable @relation(fields: [tableId], references: [id], onDelete: Cascade)
  tableId         Int
}

enum PostgresqlDatasourceTableColumnType {
  STRING
  NUMBER
  JSON
}

model ElasticsearchDatasource {
  id                             String                         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  node                           String
  createdAt                      DateTime                       @default(now())
  updatedAt                      DateTime                       @updatedAt
  elasticsearchDatasourceIndices ElasticsearchDatasourceIndex[]
}

model ElasticsearchDatasourceIndex {
  id                 Int                                 @id @default(autoincrement())
  name               String
  createdAt          DateTime                            @default(now())
  updatedAt          DateTime                            @updatedAt
  datasource         ElasticsearchDatasource             @relation(fields: [datasourceId], references: [id])
  datasourceId       String                              @db.Uuid
  fields             ElasticsearchDatasourceIndexField[]
  datatransPipelines DatatransPipeline[]
}

model ElasticsearchDatasourceIndexField {
  id          Int                          @id @default(autoincrement())
  field       String // The field name. 
  fieldBody   Json // The field's JSON format information from elasticsearch.
  createdAt   DateTime                     @default(now())
  updatedAt   DateTime                     @updatedAt
  index       ElasticsearchDatasourceIndex @relation(fields: [indexId], references: [id], onDelete: Cascade)
  indexId     Int
  databoard   ElasticsearchDataboard?      @relation(fields: [databoardId], references: [id])
  databoardId String?                      @db.Uuid
}

model DatatransPipeline {
  id                      String                       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                    String
  state                   DatatransPipelineState       @default(IDLE)
  hasManyTables           String[] // The child tables should be loaded into the payload to be transported.
  belongsToTables         String[] // The parent tables should be loaded into the payload to be transported.
  numberOfRecordsPerBatch Int                          @default(100) // The quantity of a batch of payload to be transported.
  queueUrl                String? // If the queueUrl is null, the datapipe's status can not be ACTIVE.
  createdAt               DateTime                     @default(now())
  updatedAt               DateTime                     @updatedAt
  fromTable               PostgresqlDatasourceTable    @relation(fields: [fromTableId], references: [id], onDelete: Cascade)
  fromTableId             Int
  toIndex                 ElasticsearchDatasourceIndex @relation(fields: [toIndexId], references: [id])
  toIndexId               Int
}

enum DatatransPipelineState {
  IDLE
  BATCHING
  STREAMING
}

model ElasticsearchDataboard {
  id                    String                              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                  String
  description           String?
  status                ElasticsearchDataboardStatus
  indexJson             Json?
  layoutConfig          Json?
  visualSettings        Json?
  createdAt             DateTime                            @default(now())
  updatedAt             DateTime                            @updatedAt
  datasourceIndexFields ElasticsearchDatasourceIndexField[]
}

enum ElasticsearchDataboardStatus {
  ACTIVE
  INACTIVE
}
